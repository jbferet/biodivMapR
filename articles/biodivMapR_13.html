<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROGYSAT#3: Run biodivMapR on selected spectral indices • biodivMapR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="PROGYSAT#3: Run biodivMapR on selected spectral indices">
<meta property="og:description" content="biodivMapR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">biodivMapR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.9.10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/biodivMapR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/biodivMapR_01.html">Prepare your data</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_02.html">Set parameters for biodivMapR</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_03.html">Perform spatial &amp; spectral filtering</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_04.html">PCA &amp; Dimensionality reduction</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_05.html">Spectral species mapping</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_06.html">alpha and beta diversity maps</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_07.html">Functional Diversity</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_08.html">How to perform validation?</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_09.html">Compute diversity from user-defined set of layers</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_10.html">Map diversity from Lautaret HS image</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_11.html">PROGYSAT#1: download S2 data</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_12.html">PROGYSAT#2: Run biodivMapR on S2 reflectance data</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_13.html">PROGYSAT#3: Run biodivMapR on selected spectral indices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jbferet/biodivMapR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>PROGYSAT#3: Run biodivMapR on selected spectral
indices</h1>
                        <h4 data-toc-skip class="author">Jean-Baptiste
Féret</h4>
            
            <h4 data-toc-skip class="date">2023-01-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jbferet/biodivMapR/blob/HEAD/vignettes/biodivMapR_13.Rmd" class="external-link"><code>vignettes/biodivMapR_13.Rmd</code></a></small>
      <div class="hidden name"><code>biodivMapR_13.Rmd</code></div>

    </div>

    
    
<p>This tutorial illustrates an alternative approach to compute spectral
diversity with <code>biodivMapR</code>, This approach uses a selection
of spectral indices instead of reflectance data, as described in the <a href="https://jbferet.github.io/biodivMapR/articles/biodivMapR_12.html" class="external-link">standard
mode</a>. If these spectral indices are appropriately selected in order
to ensure minimum intercorrelation, they can be used directly for the
computation of the spectral species, bypassing the preprocessing and
dimensionality reduction with PCA.</p>
<p>The computation of the spectral indices is based on the R package <a href="https://gitlab.com/jbferet/spinr" class="external-link"><code>spinR</code></a>, which
needs to be installed first:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_gitlab</span><span class="op">(</span><span class="st">'jbferet/spinR'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">spinR</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="set-data-path-and-parameters-for-biodivmapr">Set data path and parameters for biodivMapR<a class="anchor" aria-label="anchor" href="#set-data-path-and-parameters-for-biodivmapr"></a>
</h3>
<p>The data used here correspond to the data obtained from the
application of <a href="https://jbferet.github.io/biodivMapR/articles/biodivMapR_11.html" class="external-link">this
tutorial</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># libraries used in this script</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jbferet/biodivMapR" class="external-link">biodivMapR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">################################################################################</span></span>
<span><span class="co">## define data path and general parameterization for biodivMapR</span></span>
<span><span class="co">################################################################################</span></span>
<span><span class="co"># define data location</span></span>
<span><span class="va">Data_Path</span> <span class="op">&lt;-</span> <span class="st">'../03_RESULTS'</span></span>
<span><span class="va">S2_Acq</span> <span class="op">&lt;-</span> <span class="st">'L2A_T21NYF_A018869_20201016T141050'</span></span>
<span><span class="va">Input_Image_File</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">Data_Path</span>, <span class="va">S2_Acq</span>, <span class="st">'L2A_T21NYF_A018869_20201016T141050_Refl'</span><span class="op">)</span></span>
<span><span class="va">Input_Mask_File</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">Data_Path</span>, <span class="va">S2_Acq</span>, <span class="st">'CloudMask_Binary'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">biodivMapR_Dir</span> <span class="op">&lt;-</span> <span class="st">'../03_RESULTS/biodivMapR'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">biodivMapR_Dir</span>,showWarnings <span class="op">=</span> <span class="cn">FALSE</span>,recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set parameters</span></span>
<span><span class="va">Continuum_Removal</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">NDVI_Thresh</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">Blue_Thresh</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">NIR_Thresh</span> <span class="op">&lt;-</span> <span class="fl">1500</span></span>
<span><span class="va">TypePCA</span> <span class="op">&lt;-</span> <span class="st">'SI'</span></span>
<span><span class="va">FilterPCA</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">window_size</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">nbCPU</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">MaxRAM</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">nbclusters</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="co"># these parameters will be defined internally at some point, so users do not have to define them</span></span>
<span><span class="va">nb_partitions</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">Pix_Per_Partition</span> <span class="op">&lt;-</span> <span class="fl">250000</span> </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="perform-radiometric-filtering">Perform radiometric filtering<a class="anchor" aria-label="anchor" href="#perform-radiometric-filtering"></a>
</h3>
<p>The radiometric filtering is important when running biodivMapR, for
the same reason as explained in the <a href="https://jbferet.github.io/biodivMapR/articles/biodivMapR_12.html" class="external-link">previous
tutorial</a></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Input_Mask_File</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_radiometric_filtering.html">perform_radiometric_filtering</a></span><span class="op">(</span>Image_Path <span class="op">=</span> <span class="va">Input_Image_File</span>, </span>
<span>                                                 Mask_Path <span class="op">=</span> <span class="va">Input_Mask_File</span>,</span>
<span>                                                 Output_Dir <span class="op">=</span> <span class="va">biodivMapR_Dir</span>, TypePCA <span class="op">=</span> <span class="va">TypePCA</span>,</span>
<span>                                                 NDVI_Thresh <span class="op">=</span> <span class="va">NDVI_Thresh</span>, Blue_Thresh <span class="op">=</span> <span class="va">Blue_Thresh</span>,</span>
<span>                                                 NIR_Thresh <span class="op">=</span> <span class="va">NIR_Thresh</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="compute-spectral-indices-from-sentinel-2">Compute spectral indices from Sentinel-2<a class="anchor" aria-label="anchor" href="#compute-spectral-indices-from-sentinel-2"></a>
</h3>
<p>Once radiometric thresholding is done, spectral indices are directly
computed from Sentinel-2 images with the function
<code>ComputeSpectralIndices_Raster</code> included in
<code>spinR</code>. Here, we selected four spectral indices.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. read raster and corresponding spectral bands</span></span>
<span><span class="va">ImBrick</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html" class="external-link">brick</a></span><span class="op">(</span><span class="va">Input_Image_File</span><span class="op">)</span></span>
<span><span class="va">HDR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ENVI_header.html">read_ENVI_header</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_HDR_name.html">get_HDR_name</a></span><span class="op">(</span><span class="va">Input_Image_File</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">SensorBands</span> <span class="op">&lt;-</span> <span class="va">HDR</span><span class="op">$</span><span class="va">wavelength</span></span>
<span></span>
<span><span class="co"># 2. compute a list of spectral indices using spinR package</span></span>
<span><span class="va">Sel_Indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'EVI'</span>,<span class="st">'CR_SWIR'</span>,<span class="st">'CRI1'</span>,<span class="st">'NDVI'</span><span class="op">)</span></span>
<span><span class="va">Spectral_Indices</span> <span class="op">&lt;-</span> <span class="fu">spinR</span><span class="fu">::</span><span class="fu">ComputeSpectralIndices_Raster</span><span class="op">(</span><span class="va">ImBrick</span>, <span class="va">SensorBands</span>, Sel_Indices<span class="op">=</span><span class="va">Sel_Indices</span>, </span>
<span>                                                           StackOut<span class="op">=</span><span class="cn">T</span>,ReflFactor <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="write-raster-stack-of-spectral-indices-and-udated-shade-mask">Write raster stack of spectral indices and udated shade mask<a class="anchor" aria-label="anchor" href="#write-raster-stack-of-spectral-indices-and-udated-shade-mask"></a>
</h3>
<p>The spectral indices obtained in the previous section are then used
to refine the mask: extreme values which were not filtered out with the
cloud mask and radiometric filtering may still remain. In order to
reduce the risk of outliers to bias the analysis, a filtering based on
interquartile range statistics is performed.</p>
<p>The updated shade mask combines the cloud mask produced with sen2Cor,
the radiometric filter, and the outlier detection for each spectral
index. It is written in the biodvMapR output directory.</p>
<p>The spectral indices raster stack is written in the same location as
the reflectance raster.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># adjust mask to discard extreme values from spectral indices</span></span>
<span><span class="va">Mask</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">*</span><span class="va">Spectral_Indices</span><span class="op">$</span><span class="va">SpectralIndices</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span></span>
<span><span class="co"># remove outliers from spectral indices</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">idx</span> <span class="kw">in</span> <span class="va">Sel_Indices</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rast</span> <span class="op">&lt;-</span> <span class="va">Spectral_Indices</span><span class="op">$</span><span class="va">SpectralIndices</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">IQRminmax</span> <span class="op">&lt;-</span> <span class="fu">biodivMapR</span><span class="fu">::</span><span class="fu"><a href="../reference/IQR_outliers.html">IQR_outliers</a></span><span class="op">(</span>DistVal <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">rast</span><span class="op">)</span>,weightIRQ <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">Mask</span><span class="op">[</span><span class="va">rast</span><span class="op">&lt;</span><span class="va">IQRminmax</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">|</span> <span class="va">rast</span><span class="op">&gt;</span><span class="va">IQRminmax</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># combine with mask produced from radiometric filtering</span></span>
<span><span class="va">radiometricMask</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></span><span class="op">(</span><span class="va">Input_Mask_File</span><span class="op">)</span></span>
<span><span class="va">radiometricMask</span> <span class="op">&lt;-</span> <span class="va">Mask</span><span class="op">*</span><span class="va">radiometricMask</span></span>
<span><span class="va">radiometricMask</span><span class="op">[</span><span class="va">radiometricMask</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="co"># apply mask on stack and convert as stars object</span></span>
<span><span class="va">StarsObj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars</a></span><span class="op">(</span><span class="va">Spectral_Indices</span><span class="op">$</span><span class="va">SpectralIndices</span><span class="op">*</span><span class="va">radiometricMask</span><span class="op">)</span></span>
<span><span class="co"># convert NA to 0 as expected in biodivMapR</span></span>
<span><span class="va">Mask</span> <span class="op">&lt;-</span> <span class="va">radiometricMask</span></span>
<span><span class="va">Mask</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Mask</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co">################################################################################</span></span>
<span><span class="co">## Write spectral indices and mask</span></span>
<span><span class="co">################################################################################</span></span>
<span><span class="co"># define path where to store spectral indices</span></span>
<span><span class="va">NameStack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">S2_Acq</span>,<span class="st">'_SI'</span>,sep <span class="op">=</span> <span class="st">''</span><span class="op">)</span></span>
<span><span class="va">Input_SI_File</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">Data_Path</span>,<span class="va">S2_Acq</span>,<span class="va">NameStack</span><span class="op">)</span></span>
<span><span class="co"># save mask in raster file</span></span>
<span><span class="va">Input_Mask_File</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">Input_Mask_File</span>,<span class="st">'_Update'</span>,sep <span class="op">=</span> <span class="st">''</span><span class="op">)</span></span>
<span><span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/write_stars.html" class="external-link">write_stars</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars</a></span><span class="op">(</span><span class="va">Mask</span><span class="op">)</span>, dsn<span class="op">=</span><span class="va">Input_Mask_File</span>, driver <span class="op">=</span>  <span class="st">"ENVI"</span>,type<span class="op">=</span><span class="st">'Byte'</span><span class="op">)</span></span>
<span><span class="co"># save Stack of spectral indices in raster file with spectral indices defining band names</span></span>
<span><span class="fu"><a href="../reference/write_StarsStack.html">write_StarsStack</a></span><span class="op">(</span>StarsObj <span class="op">=</span> <span class="va">StarsObj</span>, dsn <span class="op">=</span> <span class="va">Input_SI_File</span>, BandNames <span class="op">=</span><span class="va">Sel_Indices</span>, datatype<span class="op">=</span><span class="st">'Float32'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="map-spectral-species">Map Spectral species<a class="anchor" aria-label="anchor" href="#map-spectral-species"></a>
</h3>
<p>The spectral species are then defined based on the selected
components. These spectral species result from the application of a
K-Means clustering of the selected components. The number of clusters
may impact the resulting diversity maps. Therefore, in the perspective
of operational application, the optimization of the number of clusters
based on ground information is critical.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use all spectral indices to compute diversity</span></span>
<span><span class="va">SelectedPCs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Sel_Indices</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Kmeans_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/map_spectral_species.html">map_spectral_species</a></span><span class="op">(</span>Input_Image_File <span class="op">=</span> <span class="va">Input_Image_File</span>, Output_Dir <span class="op">=</span> <span class="va">biodivMapR_Dir</span>,</span>
<span>                                    PCA_Files <span class="op">=</span> <span class="va">Input_SI_File</span>, Input_Mask_File <span class="op">=</span> <span class="va">Input_Mask_File</span>,</span>
<span>                                    Pix_Per_Partition <span class="op">=</span> <span class="va">Pix_Per_Partition</span>, nb_partitions <span class="op">=</span> <span class="va">nb_partitions</span>,</span>
<span>                                    nbCPU <span class="op">=</span> <span class="va">nbCPU</span>, MaxRAM <span class="op">=</span> <span class="va">MaxRAM</span>, nbclusters <span class="op">=</span> <span class="va">nbclusters</span>, TypePCA <span class="op">=</span> <span class="va">TypePCA</span>,</span>
<span>                                    SelectedPCs <span class="op">=</span> <span class="va">SelectedPCs</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="map-alpha-diversity">Map alpha diversity<a class="anchor" aria-label="anchor" href="#map-alpha-diversity"></a>
</h3>
<p>Alpha diversity maps can then be computed from the spectral species
distribution.</p>
<p>Several alpha diversity metrics are available (currently Richness,
Shannon, Simpson).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Index_Alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Shannon'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/map_alpha_div.html">map_alpha_div</a></span><span class="op">(</span>Input_Image_File <span class="op">=</span> <span class="va">Input_Image_File</span>, Output_Dir <span class="op">=</span> <span class="va">biodivMapR_Dir</span>, TypePCA <span class="op">=</span> <span class="va">TypePCA</span>,</span>
<span>              window_size <span class="op">=</span> <span class="va">window_size</span>, nbCPU <span class="op">=</span> <span class="va">nbCPU</span>, MaxRAM <span class="op">=</span> <span class="va">MaxRAM</span>,</span>
<span>              Index_Alpha <span class="op">=</span> <span class="va">Index_Alpha</span>, nbclusters <span class="op">=</span> <span class="va">nbclusters</span>,FullRes <span class="op">=</span> <span class="cn">F</span>, LowRes <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="map-beta-diversity">Map beta diversity<a class="anchor" aria-label="anchor" href="#map-beta-diversity"></a>
</h3>
<p>Beta diversity maps can then be computed from the spectral species
distribution.</p>
<p>Beta diversity is based on a 2-steps (or 3-steps depending on image
size) process:</p>
<ul>
<li><p>The Bray-Curtis dissimilarity is computed between each pair of
windows (defined by window_size) in the image</p></li>
<li><p>Then an ordination technique (default is Principal Coordinate
Analysis, <a href="https://towardsdatascience.com/principal-coordinates-analysis-cc9a572ce6c" class="external-link">PCoA</a>)
is applied on the dissimilarity matrix to transform it into a lower
dimension space (3-dimensions is default value), and a 3-bands raster
image is produced from the coordinates of each window in this 3D
space.</p></li>
<li><p>The explicit computation of the matrix becomes unmanageable for
large amount of windows: in this case, the dissimilarity matrix is
computed on a random subset of windows, followed by PCoA on this subset
matrix. Then the dissimilarity between each window and this random
subset is computed, and the coordinates of each window in this PCoA
space is defined based on a weighted nearest neighbors rule.</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/map_beta_div.html">map_beta_div</a></span><span class="op">(</span>Input_Image_File <span class="op">=</span> <span class="va">Input_Image_File</span>, Output_Dir <span class="op">=</span> <span class="va">biodivMapR_Dir</span>, TypePCA <span class="op">=</span> <span class="va">TypePCA</span>,</span>
<span>             window_size <span class="op">=</span> <span class="va">window_size</span>, nb_partitions<span class="op">=</span><span class="va">nb_partitions</span>, nbCPU <span class="op">=</span> <span class="va">nbCPU</span>, MaxRAM <span class="op">=</span> <span class="va">MaxRAM</span>,</span>
<span>             nbclusters <span class="op">=</span> <span class="va">nbclusters</span>, FullRes <span class="op">=</span> <span class="cn">F</span>, LowRes <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jean-Baptiste Feret, Florian de Boissieu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
