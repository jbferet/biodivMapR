<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COPERNICUS &amp; biodiv #4: download • biodivMapR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="COPERNICUS &amp; biodiv #4: download">
<meta property="og:description" content="biodivMapR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">biodivMapR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.13.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/biodivMapR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/biodivMapR_01.html">Prepare your data</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_02.html">Set parameters for biodivMapR</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_03.html">Perform spatial &amp; spectral filtering</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_04.html">PCA &amp; Dimensionality reduction</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_05.html">Spectral species mapping</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_06.html">alpha and beta diversity maps</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_07.html">Functional Diversity</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_08.html">How to perform validation?</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_09.html">Compute diversity from user-defined set of layers</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_10.html">Map diversity from Lautaret HS image</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_11.html">PROGYSAT#1: download S2 data</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_12.html">PROGYSAT#2: Run biodivMapR on S2 reflectance data</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_13.html">PROGYSAT#3: Run biodivMapR on selected spectral indices</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_14.html">COPERNICUS &amp; biodiv #1: set working environment</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_15.html">COPERNICUS &amp; biodiv #2: Get reference data</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_16.html">COPERNICUS &amp; biodiv #3: check S2 availability</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_17.html">COPERNICUS &amp; biodiv #4: download</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_18.html">COPERNICUS &amp; biodiv #5/6: Apply biodivMapR on S2 reflectance</a>
    </li>
    <li>
      <a href="../articles/biodivMapR_19.html">COPERNICUS &amp; biodiv #5/6: Apply biodivMapR on S2 spectral indices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jbferet/biodivMapR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>COPERNICUS &amp; biodiv #4: download</h1>
                        <h4 data-toc-skip class="author">Jean-Baptiste
Féret</h4>
            
            <h4 data-toc-skip class="date">2023-10-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jbferet/biodivMapR/blob/HEAD/vignettes/biodivMapR_17.Rmd" class="external-link"><code>vignettes/biodivMapR_17.Rmd</code></a></small>
      <div class="hidden name"><code>biodivMapR_17.Rmd</code></div>

    </div>

    
    
<p>Ce tutoriel accompagne la <strong>séquence 4</strong> de la section
<strong>Cartographie de la biodiversité par imagerie satellite</strong>
du module de formation <strong>COPERNICUS et biodiversité</strong> de la
Copernicus Academy.</p>
<p>Il permet de télécharger puis prétraiter les données Sentinel-2
utilisées dans la suite de la formation.</p>
<div class="section level2">
<h2 id="séquence-4-1-télécharger-les-données-sentinel-2">Séquence 4.1: télécharger les données Sentinel-2<a class="anchor" aria-label="anchor" href="#s%C3%A9quence-4-1-t%C3%A9l%C3%A9charger-les-donn%C3%A9es-sentinel-2"></a>
</h2>
<p>Le script suivant permet de télécharger les données Sentinel-2
correspondant à l’image identifiée lors de la séquence précédente. La
requête nécessite de définir l’emprise de la zone d’étude à l’aide du
fichier <code>T18MZB_PeruAmazon_Subset.kml</code>, ainsi que la date
d’acquisition. L’identifiant de la tuile <code>18MZB</code> est aussi
fourni afin d’éviter de télécharger les tuiles voisines, dans le cas où
l’emprise de la zone d’étude soit à cheval sur plusieurs tuiles.</p>
<p>Ici, l’option <code>GoogleCloud = TRUE</code> permet d’effectuer le
téléchargement à partir de Google Cloud si les données Sentinel-2 au
niveau L2A ne sont pas disponibles sur le Copernicus Open Access Hub,
mais qu’elles le sont sur Google Cloud.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##____________________________________________________________________##</span></span>
<span><span class="co">##      Download Sentinel-2 image corresponding to the study area     ##</span></span>
<span><span class="co">##--------------------------------------------------------------------##</span></span>
<span><span class="co"># load preprocS2 package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">preprocS2</span><span class="op">)</span></span>
<span><span class="co"># define date of S2 acquisition</span></span>
<span><span class="va">dateAcq</span> <span class="op">&lt;-</span> <span class="st">'2022-09-14'</span></span>
<span><span class="co"># define path for vector file defining the study area and corresponding tile</span></span>
<span><span class="va">path_vector</span> <span class="op">&lt;-</span> <span class="st">'../01_DATA/T18MZB_PeruAmazon_Subset.kml'</span></span>
<span><span class="va">tile</span> <span class="op">&lt;-</span> <span class="st">'18MZB'</span></span>
<span><span class="co"># define output directory where SAFE file is stored</span></span>
<span><span class="va">DirWrite</span> <span class="op">&lt;-</span> <span class="st">'../01_DATA/S2_Images'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">DirWrite</span>,showWarnings <span class="op">=</span> <span class="cn">F</span>, recursive <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Path_S2</span> <span class="op">&lt;-</span> <span class="fu">preprocS2</span><span class="fu">::</span><span class="fu">get_S2_L2A_Image</span><span class="op">(</span>l2a_path <span class="op">=</span> <span class="va">DirWrite</span>, </span>
<span>                                       spatial_extent <span class="op">=</span> <span class="va">path_vector</span>, </span>
<span>                                       tile <span class="op">=</span> <span class="va">tile</span>, </span>
<span>                                       dateAcq <span class="op">=</span> <span class="va">dateAcq</span>,</span>
<span>                                       GoogleCloud <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Une fois ces lignes exécutées, les données Sentinel-2 sont écrites
dans le répertoire <code>01_DATA\S2_Images</code>.</p>
<p>Les données Sentinel-2 sont fournies par l’ESA sous forme d’un
répertoire <a href="https://sentinels.copernicus.eu/web/sentinel/user-guides/sentinel-2-msi/data-formats" class="external-link"><code>.SAFE</code></a>,
qui contient l’ensemble des données et métadonnées associées à la
tuile.</p>
</div>
<div class="section level2">
<h2 id="séquence-4-2-prétraiter-les-données-sentinel-2">Séquence 4.2: prétraiter les données Sentinel-2<a class="anchor" aria-label="anchor" href="#s%C3%A9quence-4-2-pr%C3%A9traiter-les-donn%C3%A9es-sentinel-2"></a>
</h2>
<p>Le prétraitement des données Sentinel-2 consiste à extraire
l’ensemble des données de reflectance du répertoire SAFE, ainsi qu’un
certain nombre de métadonnées, puis à effectuer les opérations suivantes
:</p>
<ul>
<li><p>Découpage de la tuile pour ne conserver que la zone
d’étude</p></li>
<li><p>Harmonisation de la résolution spatiale : les bandes acquises
avec une résolution spatiale de 20 m sont échantillonnées à 10 m à
l’aide d’une interpolation (bilinéaire par défaut).</p></li>
<li><p>Empilement des bandes spectrales : un stack est préparé afin de
produire un fichier raster unique contenant les 10 bandes spectrales
Sentinel-2</p></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##____________________________________________________________________##</span></span>
<span><span class="co">##                  Extract, resample &amp; stack data                    ##</span></span>
<span><span class="co">##--------------------------------------------------------------------##</span></span>
<span><span class="co"># define resolution</span></span>
<span><span class="va">resolution</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="co"># define source of data</span></span>
<span><span class="va">S2source</span> <span class="op">&lt;-</span> <span class="st">'SAFE'</span></span>
<span><span class="va">S2obj</span> <span class="op">&lt;-</span> <span class="fu">preprocS2</span><span class="fu">::</span><span class="fu">extract_from_S2_L2A</span><span class="op">(</span>Path_dir_S2 <span class="op">=</span> <span class="va">Path_S2</span>,</span>
<span>                                        path_vector <span class="op">=</span> <span class="va">path_vector</span>,</span>
<span>                                        S2source <span class="op">=</span> <span class="va">S2source</span>,</span>
<span>                                        resolution <span class="op">=</span> <span class="va">resolution</span><span class="op">)</span></span></code></pre></div>
<p>L’exécution du script ci-dessus fournit un objet
<code>stars_proxy</code>, qui contient l’ensemble des informations
nécessaires à la production d’un fichier correspondant aux données
Sentinel-2 prétraitées, ainsi que le masque nuage associé.</p>
<p>L’intérêt d’utiliser un tel objet <code>stars_proxy</code> est que
l’emplacement des données sources sur le disque ainsi que l’ensemble des
prétraitements à réaliser sont enregistrés dans cet objet, mais les
données ne sont pas lues. Les ressources nécessaires en terme de mémoire
sont réduites: l’application des prétraitements après lecture des
données, leur enchainement avec d’autres traitements et l’écriture des
résultats obtenus sur un espace de stockage local peuvent alors être
réalisées de manière séquentielle en découpant les données initiales en
un ensemble d’éléments de taille individuelle réduite.</p>
</div>
<div class="section level2">
<h2 id="séquence-4-3-ecrire-les-données-dimagerie-sentinel-2-dans-des-fichiers-dédiés-">Séquence 4.3: Ecrire les données d’imagerie Sentinel-2 dans des
fichiers dédiés.<a class="anchor" aria-label="anchor" href="#s%C3%A9quence-4-3-ecrire-les-donn%C3%A9es-dimagerie-sentinel-2-dans-des-fichiers-d%C3%A9di%C3%A9s-"></a>
</h2>
<p>Les données contenues dans l’objet <code>stars_proxy</code> peuvent
alors être écrites sur disque dur sous forme de fichiers raster.</p>
<p>Ici, par défaut les données sont enregistrées au format ‘ENVI BIL’,
mais d’autres formats pris en charge par GDAL sont possibles.</p>
<p>A l’issue du script ci-dessous,</p>
<ul>
<li>un fichier raster correspondant au stack des 10 bandes spectrales
Sentinel-2 est écrit à l’emplacement suivant :</li>
</ul>
<p><code>03_RESULTS/L2A_T18MZB_A028851_20220914T150957/Reflectance/L2A_T18MZB_A028851_20220914T150957_Refl</code></p>
<ul>
<li>le masque nuage correspondant est écrit à l’emplacement suivant
:</li>
</ul>
<p><code>03_RESULTS/L2A_T18MZB_A028851_20220914T150957/CloudMask/CloudMask_Binary</code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##____________________________________________________________________##</span></span>
<span><span class="co">##                Write reflectance and cloudmask files               ##</span></span>
<span><span class="co">##--------------------------------------------------------------------##</span></span>
<span><span class="co"># create result directory corresponding to Sentinel-2 acquisition</span></span>
<span><span class="va">result_path</span> <span class="op">&lt;-</span> <span class="st">'../03_RESULTS'</span></span>
<span><span class="va">results_site_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">result_path</span>,<span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">S2obj</span><span class="op">$</span><span class="va">S2_Bands</span><span class="op">$</span><span class="va">GRANULE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">results_site_path</span>,showWarnings <span class="op">=</span> <span class="cn">FALSE</span>,recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># directory for Reflectance</span></span>
<span><span class="va">Refl_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">results_site_path</span>,<span class="st">'Reflectance'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">Refl_dir</span>,showWarnings <span class="op">=</span> <span class="cn">FALSE</span>,recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># filename for Reflectance</span></span>
<span><span class="va">Refl_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">Refl_dir</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">S2obj</span><span class="op">$</span><span class="va">S2_Bands</span><span class="op">$</span><span class="va">GRANULE</span><span class="op">)</span>,<span class="st">'_Refl'</span>,sep <span class="op">=</span> <span class="st">''</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Save Reflectance file and corresponding metadata files</span></span>
<span><span class="fu">preprocS2</span><span class="fu">::</span><span class="fu">save_reflectance_s2</span><span class="op">(</span>S2_stars <span class="op">=</span> <span class="va">S2obj</span><span class="op">$</span><span class="va">S2_Stack</span>, </span>
<span>                               Refl_path <span class="op">=</span> <span class="va">Refl_path</span>,</span>
<span>                               MTD <span class="op">=</span> <span class="va">S2obj</span><span class="op">$</span><span class="va">S2_Bands</span><span class="op">$</span><span class="va">metadata</span>, </span>
<span>                               MTD_MSI <span class="op">=</span> <span class="va">S2obj</span><span class="op">$</span><span class="va">S2_Bands</span><span class="op">$</span><span class="va">metadata_MSI</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># directory for cloud mask</span></span>
<span><span class="va">Cloud_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">results_site_path</span>,<span class="st">'CloudMask'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">Cloud_path</span>,showWarnings <span class="op">=</span> <span class="cn">FALSE</span>,recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Save cloud mask</span></span>
<span><span class="va">cloudmasks</span> <span class="op">&lt;-</span> <span class="fu">preprocS2</span><span class="fu">::</span><span class="fu">save_cloud_s2</span><span class="op">(</span>S2_stars <span class="op">=</span> <span class="va">S2obj</span><span class="op">$</span><span class="va">S2_Stack</span>,</span>
<span>                                       Cloud_path <span class="op">=</span> <span class="va">Cloud_path</span>,</span>
<span>                                       S2source <span class="op">=</span> <span class="va">S2source</span>, SaveRaw <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jean-Baptiste Feret, Florian de Boissieu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
